<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.6" />
<title></title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="paragraph"><p>In Day 8 you should have seen:</p></div>
<div class="ulist"><ul>
<li>
<p>
Which classes you need to specialise in order to create boss scripts
</p>
</li>
<li>
<p>
A bunch of functions that are useful for this
</p>
</li>
</ul></div>
<div class="paragraph"><p>This day is now about</p></div>
<div class="ulist"><ul>
<li>
<p>
Some thoughts about spells (as this is the thing most bosses do: Cast spells)
</p>
</li>
<li>
<p>
Implementing casting spells
</p>
</li>
</ul></div>
<div class="sect1">
<h2 id="_first_part">1. First Part</h2>
<div class="sectionbody">
<div class="paragraph"><p>For a clean scripting attempt it is expected to handle nearly everything with spells. So this part is now about the spell system.</p></div>
<div class="paragraph"><p>Any spell is cast by some caster onto some victim. And a spell will hit some targets.</p></div>
<div class="paragraph"><p>For some direct spells like ie Fireball the target will be the victim, but ie for AoE spells like ArcaneExplosion the victim will be the caster (self-cast spell), and the targets will be enemies around.</p></div>
<div class="sect2">
<h3 id="_the_spell_system">1.1. The spell system</h3>
<div class="paragraph"><p>Spells are provided in dbc form which can be extracted from the wow-client. Actually if you installed a local test server already, you will have extracted these dbc files.</p></div>
<div class="paragraph"><p>The structure (as far as known) for the spell.dbc can be seen in MaNGOS::DBCStructure.h - <tt>struct SpellEntry</tt>. However this is rather unpleasant to read and hence I <em>strongly</em> suggest to use a tool to help understanding these entries.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content"><a href="https://github.com/LordJZ/spellwork_cs">SpellWork</a>  This is a nice tool to view the spell dbc, binary files can be downloaded from the SpellWork/bin/Release directory over github</td>
</tr></table>
</div>
<div class="paragraph"><p>Basic structure of a spell:</p></div>
<div class="ulist"><ul>
<li>
<p>
Id and name - this identifies a spell
</p>
</li>
<li>
<p>
Some internal information
</p>
</li>
<li>
<p>
Spell Range
</p>
</li>
<li>
<p>
Difficulty information (if exists) - If a spell has difficulty information, you only need to cast the base spell, the proper one for current difficulty will be selected by MaNGOS
</p>
</li>
<li>
<p>
Information about Cast-Time, Duration of auras and similar
</p>
</li>
<li>
<p>
Information what the spell actually does:
</p>
<div class="paragraph"><p>A spell has up to three effects (like summon or dealing damage).</p></div>
<div class="paragraph"><p>Each effect consists of:</p></div>
<div class="ulist"><ul>
<li>
<p>
The effect type (what the effect will do)
</p>
</li>
<li>
<p>
The target types (how the targeting of the spell will work - AoE, Self, enemy)
</p>
</li>
<li>
<p>
Some additional information about this effect (like how many damage, what npc will be summoned and so on)
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_the_spell_system_in_mangos">1.2. The spell system in MaNGOS</h3>
<div class="paragraph"><p>Some parts of how spells should be handled are unknown, which means we can only interpret the values from spell.dbc by what should happen (and this usually is how the handling is implemented within MaNGOS)</p></div>
<div class="paragraph"><p>It is not in the scope of this guide to give some detailed explanation of everything about how spells are handled. For this you must seriously study the MaNGOS code.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">TODO Link here to the wiki page that should exist about mangos spell system.</td>
</tr></table>
</div>
<div class="paragraph"><p>Effects and their implementation can be seen in MaNGOS:SpellEffects.cpp. Often the name of the effect gives some good clue what they will do</p></div>
<div class="paragraph"><p>Targeting can be seen in MaNGOS::Spell.cpp. Most important targets are:</p></div>
<div class="ulist"><ul>
<li>
<p>
TARGET_SELF - the effect will target the caster
</p>
</li>
<li>
<p>
TARGET_*AREA* - the effect will work as AoE spell, in case of SpellRange == 0, the spell must be self cast
</p>
</li>
<li>
<p>
TARGET_CHAIN_DAMAGE - the effect will target the victim
</p>
</li>
<li>
<p>
TARGET_SCRIPT* - the target is fixed by the table <tt>spell_script_target</tt>
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/example.png" alt="Exercise" />
</td>
<td class="content">
<div class="title"><strong>Exercise 1</strong> - Check a few spells</div>
<div class="paragraph"><p>Download SpellWork and check a few spells: Maybe IDs 9488 or 59245.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_which_spells_should_a_boss_cast">1.3. Which spells should a boss cast?</h3>
<div class="paragraph"><p>Well, by now you should have seen a few spells and be able to have a rough idea what they are doing. But of course the most important question still is: What spells should a boss use? (And when)</p></div>
<div class="paragraph"><p>To get information what spells a boss should use, you can check:</p></div>
<div class="ulist"><ul>
<li>
<p>
Database sites (like wowhead) - NPCs usually have there a list of abilities, however this can be incomplete or even wrong
</p>
</li>
<li>
<p>
Transcriptor/ Combat logs (there are sites where such are available)
</p>
</li>
<li>
<p>
The DBM Addon
</p>
</li>
<li>
<p>
Watching videos
</p>
</li>
<li>
<p>
Wowwiki and similar sites
</p>
</li>
</ul></div>
<div class="paragraph"><p>There are usually two answers of <strong>when</strong> a spell is cast:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
On a timer: This means, some time after engaging combat, and then repeating after some time.
</p>
</li>
<li>
<p>
On some event: Like 50% health, or when an add dies
</p>
</li>
</ol></div>
<div class="paragraph"><p>To figure this you must use resources like videos, experience or a bunch of logs (and of course good guessing also helps)</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_end_of_first_part">2. End of first part</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this part you should have seen how a spell looks like, and how to obtain information about its use.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_second_part">3. Second Part:</h2>
<div class="sectionbody">
<div class="paragraph"><p>This part now will look about how spell casting is to be implemented in MaNGOS.</p></div>
<div class="paragraph"><p>The main function that will be used for spell casting is:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>DoCastSpellIfCan(Unit* pVictim, uint32 uiSpellId); which returns a value of type CastResult</tt></pre>
</div></div>
<div class="sect2">
<h3 id="_the_virtual_function_updateai_const_uint32_uidiff">3.1. The virtual function UpdateAI(const uint32 uiDiff)</h3>
<div class="paragraph"><p>MaNGOS calls for every AI the function <tt>UpdateAI(const uint32 uiDiff)</tt> about every 100ms. The actual time since last call is stored in uiDiff.</p></div>
<div class="paragraph"><p>This gives two possibilites:</p></div>
<div class="ulist"><ul>
<li>
<p>
Handle things that should be handled always
</p>
</li>
<li>
<p>
Countdown a timer
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_how_does_a_timer_work_if_we_know_the_time_diff_since_we_last_called_a_function">3.1.1. How does a timer work, if we know the time-diff since we last called a function?</h4>
<div class="paragraph"><p>A timer is a variable of type uin32 (unsingned integer), which stores the time until the timer should expire next (in millieseconds)</p></div>
<div class="paragraph"><p>So, a minimal timer script would look like:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>struct MANGOS_DLL_DECL boss_dummyAI : public ScriptedAI
{
    boss_dummyAI(Creature* pCreature) : ScriptedAI(pCreature)
    {
        Reset();
    }

    uint32 m_uiTimer;                                              <img src="./images/icons/callouts/1.png" alt="1" />

    void Reset()                                                   <img src="./images/icons/callouts/2.png" alt="2" />
    {
        m_uiTimer = 17000;                                         <img src="./images/icons/callouts/3.png" alt="3" />
    }

    void UpdateAI(const uint32 uiDiff)                             <img src="./images/icons/callouts/4.png" alt="4" />
    {
        if (m_uiTimer &lt; uiDiff)                                    <img src="./images/icons/callouts/6.png" alt="6" />
        {
            DoScriptText(-1000001, m_creature);                    <img src="./images/icons/callouts/7.png" alt="7" />
            m_uiTimer = 30000;                                     <img src="./images/icons/callouts/8.png" alt="8" />
        }
        else
            m_uiTimer -= uiDiff;                                   <img src="./images/icons/callouts/5.png" alt="5" />
    }
};</tt></pre>
</div></div>
<div class="paragraph"><p>Note that this misses all stuff like registering the script, but you should be able to test it, if you move the content to some other empty script (maybe festergut)</p></div>
<div class="paragraph"><p>The meaning of the new lines:</p></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
In this line the member variable <tt>m_uiTimer</tt> of the struct boss_dummyAI is defined.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
This is the virtual Reset function that every script implements.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
And we reset here the timer to the initially value.
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
Here we overwrite the UpdateAI function, that will be called every <tt>uiDiff</tt> millieseconds.
</td></tr>
<tr><td><img src="./images/icons/callouts/5.png" alt="5" /></td><td>
If the timer is not expired ("else") we decrement it.
</td></tr>
<tr><td><img src="./images/icons/callouts/6.png" alt="6" /></td><td>
We check if the timer is expired (which means it is time to do something for which we need the timer)
</td></tr>
<tr><td><img src="./images/icons/callouts/7.png" alt="7" /></td><td>
Some Text will be displayed
</td></tr>
<tr><td><img src="./images/icons/callouts/8.png" alt="8" /></td><td>
The timer will be set to a new value
</td></tr>
</table></div>
<div class="paragraph"><p>Currently this function only contains the timer handling.</p></div>
<div class="sect4">
<h5 id="_how_exactly_does_a_timer_work">How exactly does a timer work</h5>
<div class="paragraph"><p>It is probably a good idea to clarify this with pen and paper: Think what will happen in the code (assume the UpdateAI is called every 100ms)</p></div>
<div class="paragraph"><p>When the script is initialized the timer will be 17000. On first <em>tick</em> of UpdateAI evaluating the code looks like:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>    void UpdateAI(const uint32 uiDiff==100)
    {
        if (m_uiTimer==17000 &lt; 100)    // evaluates to false
        {
            DoScriptText(-1000001, m_creature);
            m_uiTimer = 30000;
        }
        else
            m_uiTimer==17000 -= 100;
    }</tt></pre>
</div></div>
<div class="paragraph"><p>When this code is finished, m_uiTimer will be decremented by 100, and has then the value of 16900.</p></div>
<div class="paragraph"><p>The next tick would look like:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>    void UpdateAI(const uint32 uiDiff==100)
    {
        if (m_uiTimer==16900 &lt; 100)    // evaluates to false
        {
            DoScriptText(-1000001, m_creature);
            m_uiTimer = 30000;
        }
        else
            m_uiTimer==16900 -= 100;
    }</tt></pre>
</div></div>
<div class="paragraph"><p>When this code is finished, m_uiTimer will be decremented by 100, and has then the value of 16800.</p></div>
<div class="paragraph"><p>After a bunch of more <em>ticks</em> the code will evaluate to (Exercise: How many ticks? - How long does it take?)</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>    void UpdateAI(const uint32 uiDiff==100)
    {
        if (m_uiTimer==0 &lt; 100)    // evaluates to true
        {
            DoScriptText(-1000001, m_creature);
            m_uiTimer = 30000;
        }
        else
            m_uiTimer==0 -= 100;
    }</tt></pre>
</div></div>
<div class="paragraph"><p>And the timer will be expired, and the actions that should happen when the timer is expired will be triggered.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/example.png" alt="Exercise" />
</td>
<td class="content">
<div class="title"><strong>Exercise 2</strong> - Understand the timer</div>
<div class="paragraph"><p>When will the timer first expire?</p></div>
<div class="paragraph"><p>When will the timer the second time expire?</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/example.png" alt="Exercise" />
</td>
<td class="content">
<div class="title"><strong>Exercise 3</strong> - Understand the timer(2)</div>
<div class="paragraph"><p>Change the code so that the timer will initially expire after 10seconds, and from then expire every 30-40 seconds. (Hint: <tt>urand(A, B)</tt> gives a random number between A and B)</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_what_other_stuff_fits_well_into_the_updateai_function">3.1.2. What other stuff fits well into the UpdateAI function?</h4>
<div class="paragraph"><p>In normal cases we want to script combat behaviour. And most important for combating is of course threat management (whom the boss should attack).</p></div>
<div class="paragraph"><p>This is handled by MaNGOS with the function <tt>SelectHostileTarget</tt>.</p></div>
<div class="paragraph"><p>Also we normally want a boss to do melee attack.</p></div>
<div class="paragraph"><p>This is handled by MaNGOS with the function <tt>DoMeleeAttackIfReady</tt>.</p></div>
<div class="paragraph"><p>So the structure for a normal <tt>UpdateAI</tt> should look like this (changes might be reasonable, but only very rarely)</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>    void UpdateAI(const uint32 uiDiff)
    {
        if (!m_creature-&gt;SelectHostileTarget() || !m_creature-&gt;getVictim())
           return;              <img src="./images/icons/callouts/1.png" alt="1" />

        // Some combat Timers

        DoMeleeAttackIfReady();
    }</tt></pre>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
As of this return anything after will only be executed when we are in proper combat.
</td></tr>
</table></div>
</div>
</div>
<div class="sect2">
<h3 id="_real_example_let_festergut_cast_something">3.2. Real example: Let Festergut cast something</h3>
<div class="paragraph"><p>On <a href="http://old.wowhead.com/npc=36626#abilities">wowhead-Festergut</a> I found a spell ID for the Berserk spell as well as the information that the berserk should happen after 5 minutes (initially)</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>diff --git a/scripts/northrend/icecrown_citadel/icecrown_citadel/boss_festergut.cpp b/scripts/northrend/icecrown_citadel/icecrown_citadel/boss_festergut.cpp
index b059c1f..30ec25e 100644
--- a/scripts/northrend/icecrown_citadel/icecrown_citadel/boss_festergut.cpp
+++ b/scripts/northrend/icecrown_citadel/icecrown_citadel/boss_festergut.cpp
@@ -36,6 +36,8 @@ enum
     SAY_BERSERK                 = -1631089,
     SAY_DEATH                   = -1631090,
     SAY_FESTERGUT_DEATH         = -1631091,
+
+    SPELL_BERSERK               = 47008,                          <img src="./images/icons/callouts/1.png" alt="1" />
 };

 struct MANGOS_DLL_DECL boss_festergutAI : public ScriptedAI
@@ -45,8 +47,11 @@ struct MANGOS_DLL_DECL boss_festergutAI : public ScriptedAI
         Reset();
     }

+    uint32 m_uiBerserkTimer;                                      <img src="./images/icons/callouts/2.png" alt="2" />
+
     void Reset()
     {
+        m_uiBerserkTimer = 5*MINUTE*IN_MILLISECONDS;
     }

     void Aggro(Unit* pWho)
@@ -58,6 +63,21 @@ struct MANGOS_DLL_DECL boss_festergutAI : public ScriptedAI
     {
         DoScriptText(urand(0, 1) ? SAY_SLAY_1 : SAY_SLAY_2, m_creature);
     }
+
+    void UpdateAI(const uint32 uiDiff)
+    {
+        if (!m_creature-&gt;SelectHostileTarget() || !m_creature-&gt;getVictim())
+            return;
+
+        if (m_uiBerserkTimer &lt; uiDiff)                            <img src="./images/icons/callouts/3.png" alt="3" />
+        {
+            DoCastSpellIfCan(m_creature, SPELL_BERSERK);
+            DoScriptText(SAY_BERSERK, m_creature);
+            m_uiBerserkTimer = 5*MINUTE*IN_MILLISECONDS;
+        }
+        else
+            m_uiBerserkTimer -= uiDiff;
+    }
 };

 CreatureAI* GetAI_boss_festergut(Creature* pCreature)</tt></pre>
</div></div>
<div class="paragraph"><p>What is done here:</p></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
The Berserk spell ID is assigned to an enum (to prevent so called magic numbers)
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
As we can expect that there will be additional timers for this boss, we must find unique names for every timer, usually this works well with the spellname.
<div class="paragraph"><p>Also note the <a href="http://www.scriptdev2.com/showthread.php?t=4098">ScriptDev2 Coding Standards</a></p></div>
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
The actual implementation of the timer. From the infos there should be besides the casting of the berserk spell also a text displayed that Festergut enrages.
</td></tr>
</table></div>
<div class="paragraph"><p>This patch was commited with bd821056ec9f</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/example.png" alt="Exercise" />
</td>
<td class="content">
<div class="title"><strong>Exercise 4</strong> - Add some abilities to your own script</div>
<div class="paragraph"><p>Write a script for an own boss and add some abilites, or add some abilites to Festergut here.</p></div>
<div class="paragraph"><p>Provide patches to the forum thread!</p></div>
<div class="paragraph"><p>Also note from which sources you got which info - good place for this would be the commit message</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_end_of_second_part">4. End of second part</h2>
<div class="sectionbody">
<div class="paragraph"><p>What you should have seen today:</p></div>
<div class="ulist"><ul>
<li>
<p>
How spells work
</p>
</li>
<li>
<p>
How to cast spells on a timer
</p>
</li>
</ul></div>
<div class="paragraph"><p>What comes next:</p></div>
<div class="ulist"><ul>
<li>
<p>
Using events to trigger some stuff
</p>
</li>
<li>
<p>
Using phases
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2011-10-28 15:10:35 Mitteleurop√§ische Sommerzeit
</div>
</div>
</body>
</html>
